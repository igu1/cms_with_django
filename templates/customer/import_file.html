{% extends 'base.html' %}

{% block title %}Import Data - {{ COMPANY_NAME }}{% endblock %}

{% block header %}Import Customer Data{% endblock %}
{% block header_icon %}<i class="fas fa-file-import"></i>{% endblock %}
{% block subheader %}Upload XLSX or CSV files with customer information{% endblock %}

{% block content %}
<div class="card-enhanced bg-white shadow-md overflow-hidden sm:rounded-lg animate-fadeIn">
    <div class="px-4 py-5 sm:p-6">
        <form method="POST" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}


            <div class="mb-8">
                <label for="file" class="block text-sm font-medium text-gray-700 mb-2">Upload File</label>
                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg transition-all duration-300 hover:border-indigo-300 hover:bg-indigo-50" id="drop-area">
                    <div class="space-y-2 text-center">
                        <div class="mx-auto h-16 w-16 text-indigo-400 animate-pulse">
                            <i class="fas fa-file-upload text-5xl"></i>
                        </div>
                        <div class="flex flex-col sm:flex-row justify-center text-sm text-gray-600">
                            <label for="file" class="relative cursor-pointer bg-indigo-50 px-4 py-2 rounded-md font-medium text-indigo-600 hover:text-indigo-700 hover:bg-indigo-100 transition-colors duration-200 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500">
                                <span><i class="fas fa-upload mr-1"></i> Choose a file</span>
                                <input id="file" name="file" type="file" class="hidden" accept=".xlsx,.csv">
                            </label>
                            <p class="mt-2 sm:mt-0 sm:ml-3 flex items-center">or drag and drop here</p>
                        </div>
                        <div class="flex flex-wrap justify-center gap-2 mt-2">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                <i class="fas fa-file-excel mr-1"></i> XLSX
                            </span>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                <i class="fas fa-file-csv mr-1"></i> CSV
                            </span>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                <i class="fas fa-weight mr-1"></i> Max 10MB
                            </span>
                        </div>
                    </div>
                </div>
                <div id="file-name" class="mt-3 text-sm text-gray-600 flex items-center"></div>
                <div id="file-error" class="mt-3 text-sm text-red-500 hidden flex items-center"><i class="fas fa-exclamation-circle mr-1"></i> <span></span></div>
                <div class="mt-3 text-xs text-gray-500"><i class="fas fa-info-circle mr-1"></i> Make sure your file has the required columns and follows the format specified below.</div>
            </div>

            <div class="bg-gray-50 p-4 rounded-md">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i class="fas fa-info-circle text-blue-400"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-gray-800">File Format Requirements</h3>
                        <div class="mt-2 text-sm text-gray-600">
                            <p>Your file should include the following columns:</p>
                            <ul class="list-disc pl-5 mt-1 space-y-1">
                                <li><strong>name</strong> (required): Customer's full name</li>
                                <li><strong>phone_number</strong> (required): Customer's phone number</li>
                                <li><strong>area</strong> (optional): Customer's area/location</li>
                                <li><strong>date</strong> (optional): Relevant date (YYYY-MM-DD format)</li>
                                <li><strong>status</strong> (optional): Customer status (VALID, INVALID, CALL_NOT_ATTENDED, etc.)</li>
                                <li><strong>remark</strong> (optional): Additional remarks</li>
                            </ul>
                            <div class="mt-3 p-3 bg-indigo-50 rounded-md">
                                <h4 class="text-xs font-semibold text-indigo-700 mb-1">Available Status Values:</h4>
                                <div class="grid grid-cols-2 gap-2 text-xs">
                                    <div><span class="inline-block w-3 h-3 rounded-full bg-red-500 mr-1"></span> INVALID</div>
                                    <div><span class="inline-block w-3 h-3 rounded-full bg-green-500 mr-1"></span> VALID</div>
                                    <div><span class="inline-block w-3 h-3 rounded-full bg-yellow-500 mr-1"></span> CALL_NOT_ATTENDED</div>
                                    <div><span class="inline-block w-3 h-3 rounded-full bg-purple-500 mr-1"></span> PLAN_PRESENTED</div>
                                    <div><span class="inline-block w-3 h-3 rounded-full bg-blue-500 mr-1"></span> INTERESTED</div>
                                    <div><span class="inline-block w-3 h-3 rounded-full bg-gray-500 mr-1"></span> NOT_INTERESTED</div>
                                    <div><span class="inline-block w-3 h-3 rounded-full bg-indigo-500 mr-1"></span> FOLLOW_UP</div>
                                    <div><span class="inline-block w-3 h-3 rounded-full bg-green-500 mr-1"></span> SHORTLISTED</div>
                                    <div><span class="inline-block w-3 h-3 rounded-full bg-orange-500 mr-1"></span> CAMPUS_VISIT</div>
                                    <div><span class="inline-block w-3 h-3 rounded-full bg-teal-500 mr-1"></span> REGISTRATION</div>
                                    <div><span class="inline-block w-3 h-3 rounded-full bg-pink-500 mr-1"></span> ADMISSION</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-3 justify-between items-center mt-8">
                <div class="flex flex-col sm:flex-row gap-3">
                    <button type="submit" id="submit-btn" class="btn-enhanced btn-primary inline-flex items-center justify-center px-4 py-2 text-sm font-medium rounded-md shadow-md">
                        <i class="fas fa-upload mr-2"></i> Upload File
                    </button>
                    <a href="{% url 'import_history' %}" class="btn-enhanced inline-flex items-center justify-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors duration-200">
                        <i class="fas fa-history mr-2"></i> Import History
                    </a>
                </div>
                <a href="#" id="download-sample" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium inline-flex items-center transition-colors duration-200">
                    <i class="fas fa-download mr-1"></i> Download Sample Template
                </a>
            </div>


        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('file');
        const fileNameDisplay = document.getElementById('file-name');
        const fileError = document.getElementById('file-error');
        const errorText = fileError.querySelector('span');
        const dropArea = document.getElementById('drop-area');
        const form = document.querySelector('form');
        const submitBtn = document.getElementById('submit-btn');
        const downloadSampleBtn = document.getElementById('download-sample');

        // Handle file selection via input
        fileInput.addEventListener('change', function() {
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                validateAndDisplayFile(file);
            } else {
                fileNameDisplay.innerHTML = '';
                errorText.textContent = '';
                fileError.classList.add('hidden');
            }
        });

        // Handle drag and drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropArea.classList.add('border-indigo-500');
            dropArea.classList.add('bg-indigo-100');
            dropArea.querySelector('.fa-file-upload').classList.add('text-indigo-600');
        }

        function unhighlight() {
            dropArea.classList.remove('border-indigo-500');
            dropArea.classList.remove('bg-indigo-100');
            dropArea.querySelector('.fa-file-upload').classList.remove('text-indigo-600');
        }

        dropArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const file = dt.files[0];

            // Set the file to the file input
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;

            validateAndDisplayFile(file);
        }

        function validateAndDisplayFile(file) {
            const fileName = file.name;
            const fileExt = fileName.split('.').pop().toLowerCase();

            if (!['xlsx', 'csv'].includes(fileExt)) {
                fileNameDisplay.innerHTML = '';
                errorText.textContent = 'Only XLSX and CSV files are supported';
                fileError.classList.remove('hidden');
                return;
            }

            if (file.size > 10 * 1024 * 1024) { // 10MB
                fileNameDisplay.innerHTML = '';
                errorText.textContent = 'File size exceeds 10MB limit';
                fileError.classList.remove('hidden');
                return;
            }

            // Format file size
            const fileSize = formatFileSize(file.size);

            // Show file info with icon based on extension
            const fileIcon = fileExt === 'xlsx' ? 'fa-file-excel text-green-600' : 'fa-file-csv text-blue-600';
            fileNameDisplay.innerHTML = `
                <i class="fas ${fileIcon} mr-2"></i>
                <span class="font-medium">${fileName}</span>
                <span class="ml-2 text-gray-500">(${fileSize})</span>
                <button type="button" id="remove-file" class="ml-2 text-gray-400 hover:text-red-500 focus:outline-none transition-colors duration-200">
                    <i class="fas fa-times-circle"></i>
                </button>
            `;

            // Add event listener to remove button
            document.getElementById('remove-file').addEventListener('click', function() {
                fileInput.value = '';
                fileNameDisplay.innerHTML = '';
                errorText.textContent = '';
                fileError.classList.add('hidden');
            });

            errorText.textContent = '';
            fileError.classList.add('hidden');
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' bytes';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / 1048576).toFixed(1) + ' MB';
        }

        // Form submission validation
        form.addEventListener('submit', function(e) {
            if (!fileInput.files.length) {
                e.preventDefault();
                errorText.textContent = 'Please select a file to upload';
                fileError.classList.remove('hidden');
                return;
            }

            const file = fileInput.files[0];
            const fileName = file.name;
            const fileExt = fileName.split('.').pop().toLowerCase();

            if (!['xlsx', 'csv'].includes(fileExt)) {
                e.preventDefault();
                errorText.textContent = 'Only XLSX and CSV files are supported';
                fileError.classList.remove('hidden');
                return;
            }

            if (file.size > 10 * 1024 * 1024) { // 10MB
                e.preventDefault();
                errorText.textContent = 'File size exceeds 10MB limit';
                fileError.classList.remove('hidden');
                return;
            }

            // Show loading state
            showLoading(submitBtn);
        });

        // Sample template download
        downloadSampleBtn.addEventListener('click', function(e) {
            e.preventDefault();

            // Create CSV content
            const headers = ['name', 'phone_number', 'area', 'date', 'status', 'remark'];
            const sampleData = [
                ['John Doe', '9876543210', 'North Campus', '2025-05-01', 'VALID', 'Interested in Computer Science'],
                ['Jane Smith', '8765432109', 'South Campus', '2025-05-02', 'INTERESTED', 'Looking for Engineering courses'],
                ['Alex Johnson', '7654321098', 'East Campus', '2025-05-03', 'FOLLOW_UP', 'Will visit campus next week']
            ];

            let csvContent = headers.join(',') + '\n';
            sampleData.forEach(row => {
                csvContent += row.join(',') + '\n';
            });

            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', 'customer_import_template.csv');
            a.click();
        });
    });
</script>
{% endblock %}
