{% extends 'base.html' %}
{% load customer_tags %}

{% block title %}Edit Mapping - {{ COMPANY_NAME }}{% endblock %}

{% block content %}
<div class="mb-6 flex items-center justify-between">
    <div>
        <h1 class="text-2xl font-semibold text-gray-900">Edit Column Mapping: {{ mapping.name }}</h1>
        <p class="mt-1 text-sm text-gray-500">Configure how CSV columns map to customer fields</p>
    </div>
    <div>
        <a href="{% url 'mapping_list' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
            <i class="fas fa-arrow-left mr-2"></i> Back to Mappings
        </a>
    </div>
</div>

<div class="bg-white shadow overflow-hidden sm:rounded-lg">
    <div class="px-4 py-5 sm:p-6">
        <form method="POST" action="{% url 'mapping_edit' mapping.id %}" id="mapping-form">
            {% csrf_token %}

            <div class="space-y-6">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Mapping Name</label>
                    <div class="mt-1">
                        <input type="text" name="name" id="name" required value="{{ mapping.name }}" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
                    </div>
                </div>

                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700">Description (Optional)</label>
                    <div class="mt-1">
                        <textarea id="description" name="description" rows="2" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">{{ mapping.description }}</textarea>
                    </div>
                </div>

                <div class="relative flex items-start">
                    <div class="flex items-center h-5">
                        <input id="is_default" name="is_default" type="checkbox" {% if mapping.is_default %}checked{% endif %} class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded">
                    </div>
                    <div class="ml-3 text-sm">
                        <label for="is_default" class="font-medium text-gray-700">Set as Default</label>
                        <p class="text-gray-500">This mapping will be automatically selected when importing files</p>
                    </div>
                </div>

                <div class="border-t border-gray-200 pt-5">
                    <h3 class="text-lg font-medium text-gray-900">Field Mappings</h3>
                    <p class="mt-1 text-sm text-gray-500">Define how CSV columns map to customer fields</p>

                    <div class="mt-4" id="mapping-fields">
                        <div class="bg-gray-50 p-4 rounded-md mb-4">
                            <div class="flex items-start">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-info-circle text-blue-400"></i>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-gray-800">Field Mapping Instructions</h3>
                                    <div class="mt-2 text-sm text-gray-600">
                                        <p>For each CSV column, select the corresponding field in your customer database:</p>
                                        <ul class="list-disc pl-5 mt-1 space-y-1">
                                            <li><strong>CSV Column</strong>: The column name from your CSV file</li>
                                            <li><strong>Field Type</strong>: Choose between base fields (built-in) or custom fields</li>
                                            <li><strong>Field Name</strong>: The field in your database to map to</li>
                                            <li><strong>Required</strong>: Whether this field must have a value</li>
                                            <li><strong>Default Value</strong>: Value to use if the CSV cell is empty</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-300">
                                <thead>
                                    <tr>
                                        <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-0">CSV Column</th>
                                        <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Field Type</th>
                                        <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Field Name</th>
                                        <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Required</th>
                                        <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Default Value</th>
                                        <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-0">
                                            <span class="sr-only">Actions</span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200" id="mapping-table-body">
                                    {% for field in mapping_fields %}
                                    <tr class="mapping-row">
                                        <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-0">
                                            <input type="text" name="csv_column" value="{{ field.csv_column }}" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
                                        </td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                                            <select name="field_type" class="field-type-select mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                                <option value="base" {% if field.field_type == 'base' %}selected{% endif %}>Base Field</option>
                                                <option value="custom" {% if field.field_type == 'custom' %}selected{% endif %}>Custom Field</option>
                                            </select>
                                        </td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                                            <select name="field_name" class="field-name-select mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                                {% if field.field_type == 'base' %}
                                                    {% for base_field in base_fields %}
                                                    <option value="{{ base_field.name }}" {% if field.field_name == base_field.name %}selected{% endif %}>{{ base_field.label }}</option>
                                                    {% endfor %}
                                                {% else %}
                                                    {% for custom_field in custom_fields %}
                                                    <option value="{{ custom_field.name }}" {% if field.field_name == custom_field.name %}selected{% endif %}>{{ custom_field.label }}</option>
                                                    {% endfor %}
                                                {% endif %}
                                            </select>
                                        </td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                                            <input type="checkbox" name="is_required" {% if field.is_required %}checked{% endif %} class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded">
                                        </td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                                            <input type="text" name="default_value" value="{{ field.default_value }}" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
                                        </td>
                                        <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-0">
                                            <button type="button" class="remove-field text-red-600 hover:text-red-900">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-4">
                            <button type="button" id="add-field-btn" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                <i class="fas fa-plus mr-2"></i> Add Field Mapping
                            </button>
                        </div>
                    </div>
                </div>

                <div class="pt-5 border-t border-gray-200">
                    <div class="flex justify-end">
                        <a href="{% url 'mapping_list' %}" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Cancel</a>
                        <button type="submit" class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Save Mapping</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Field Type Templates (Hidden) -->
<template id="base-fields-template">
    {% for field in base_fields %}
    <option value="{{ field.name }}">{{ field.label }}</option>
    {% endfor %}
</template>

<template id="custom-fields-template">
    {% for field in custom_fields %}
    <option value="{{ field.name }}">{{ field.label }}</option>
    {% endfor %}
</template>

<template id="new-row-template">
    <tr class="mapping-row">
        <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-0">
            <input type="text" name="csv_column" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
        </td>
        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            <select name="field_type" class="field-type-select mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                <option value="base">Base Field</option>
                <option value="custom">Custom Field</option>
            </select>
        </td>
        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            <select name="field_name" class="field-name-select mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                {% for field in base_fields %}
                <option value="{{ field.name }}">{{ field.label }}</option>
                {% endfor %}
            </select>
        </td>
        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            <input type="checkbox" name="is_required" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded">
        </td>
        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            <input type="text" name="default_value" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
        </td>
        <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-0">
            <button type="button" class="remove-field text-red-600 hover:text-red-900">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    </tr>
</template>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const mappingForm = document.getElementById('mapping-form');
        const addFieldBtn = document.getElementById('add-field-btn');
        const mappingTableBody = document.getElementById('mapping-table-body');
        const newRowTemplate = document.getElementById('new-row-template');
        const baseFieldsTemplate = document.getElementById('base-fields-template');
        const customFieldsTemplate = document.getElementById('custom-fields-template');

        // Add new field mapping row
        addFieldBtn.addEventListener('click', function() {
            const newRow = document.importNode(newRowTemplate.content, true);
            mappingTableBody.appendChild(newRow);

            // Add event listeners to the new row
            addFieldTypeChangeListener(mappingTableBody.lastElementChild.querySelector('.field-type-select'));
            addRemoveButtonListener(mappingTableBody.lastElementChild.querySelector('.remove-field'));
        });

        // Handle field type change
        function addFieldTypeChangeListener(select) {
            select.addEventListener('change', function() {
                const fieldNameSelect = this.closest('tr').querySelector('.field-name-select');

                // Clear existing options
                fieldNameSelect.innerHTML = '';

                // Add new options based on field type
                if (this.value === 'base') {
                    fieldNameSelect.innerHTML = baseFieldsTemplate.innerHTML;
                } else {
                    fieldNameSelect.innerHTML = customFieldsTemplate.innerHTML;
                }
            });
        }

        // Handle remove button click
        function addRemoveButtonListener(button) {
            button.addEventListener('click', function() {
                this.closest('tr').remove();
            });
        }

        // Add event listeners to existing rows
        document.querySelectorAll('.field-type-select').forEach(addFieldTypeChangeListener);
        document.querySelectorAll('.remove-field').forEach(addRemoveButtonListener);

        // Handle form submission
        mappingForm.addEventListener('submit', function(e) {
            e.preventDefault();

            // Collect form data
            const formData = {
                name: document.getElementById('name').value,
                description: document.getElementById('description').value,
                is_default: document.getElementById('is_default').checked,
                fields: []
            };

            // Collect field mappings
            document.querySelectorAll('.mapping-row').forEach(row => {
                const csvColumn = row.querySelector('[name="csv_column"]').value;
                const fieldType = row.querySelector('[name="field_type"]').value;
                const fieldName = row.querySelector('[name="field_name"]').value;
                const isRequired = row.querySelector('[name="is_required"]').checked;
                const defaultValue = row.querySelector('[name="default_value"]').value;

                if (csvColumn && fieldName) {
                    formData.fields.push({
                        csv_column: csvColumn,
                        field_type: fieldType,
                        field_name: fieldName,
                        is_required: isRequired,
                        default_value: defaultValue
                    });
                }
            });

            // Submit the form via AJAX
            fetch(mappingForm.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name="csrfmiddlewaretoken"]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = "{% url 'mapping_list' %}";
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        });
    });
</script>
{% endblock %}
