{% extends 'base.html' %}
{% load customer_tags %}

{% block title %}Map Columns - Customer Management{% endblock %}

{% block content %}
<div class="mb-6 flex items-center justify-between">
    <div>
        <h1 class="text-2xl font-semibold text-gray-900">Map CSV Columns</h1>
        <p class="mt-1 text-sm text-gray-500">Define how columns in your file map to customer fields</p>
    </div>
    <div>
        <a href="{% url 'import_file' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
            <i class="fas fa-arrow-left mr-2"></i> Back to Import
        </a>
    </div>
</div>

<div class="bg-white shadow overflow-hidden sm:rounded-lg mb-6">
    <div class="px-4 py-5 sm:px-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900">File Preview: {{ file_name }}</h3>
        <p class="mt-1 max-w-2xl text-sm text-gray-500">First 5 rows of your data</p>
    </div>
    <div class="border-t border-gray-200 px-4 py-5 sm:p-0">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-300">
                <thead>
                    <tr>
                        {% for header in headers %}
                        <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-6">{{ header }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 bg-white">
                    {% for row in preview_data %}
                    <tr>
                        {% for header in headers %}
                        <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6">{{ row|get_item:header|default:"-" }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="bg-white shadow overflow-hidden sm:rounded-lg">
    <div class="px-4 py-5 sm:p-6">
        <form method="POST" action="{% url 'import_file' %}" id="mapping-form">
            {% csrf_token %}
            <input type="hidden" name="import_step" value="1">
            <input type="hidden" name="mapping_data" id="mapping-data">
            
            <div class="space-y-6">
                <div>
                    <h3 class="text-lg font-medium text-gray-900">Column Mapping</h3>
                    <p class="mt-1 text-sm text-gray-500">Define how columns in your file map to customer fields</p>
                    
                    {% if mappings %}
                    <div class="mt-4 bg-gray-50 p-4 rounded-md">
                        <h4 class="text-base font-medium text-gray-900">Use Existing Mapping</h4>
                        <div class="mt-2">
                            <select id="existing-mapping" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="">Select a mapping...</option>
                                {% for mapping in mappings %}
                                <option value="{{ mapping.id }}" {% if selected_mapping.id == mapping.id %}selected{% endif %}>{{ mapping.name }}{% if mapping.is_default %} (Default){% endif %}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="mt-6">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-300">
                                <thead>
                                    <tr>
                                        <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-0">CSV Column</th>
                                        <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Field Type</th>
                                        <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Field Name</th>
                                        <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Required</th>
                                        <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Default Value</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200" id="mapping-table-body">
                                    {% for header in headers %}
                                    <tr class="mapping-row">
                                        <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-0">
                                            <input type="text" name="csv_column" value="{{ header }}" readonly class="bg-gray-100 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
                                        </td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                                            <select name="field_type" class="field-type-select mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                                <option value="base">Base Field</option>
                                                <option value="custom">Custom Field</option>
                                                <option value="ignore">Ignore Column</option>
                                            </select>
                                        </td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                                            <select name="field_name" class="field-name-select mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                                {% for field in base_fields %}
                                                <option value="{{ field.name }}" {% if header|lower == field.name|lower %}selected{% endif %}>{{ field.label }}</option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                                            <input type="checkbox" name="is_required" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded">
                                        </td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                                            <input type="text" name="default_value" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="border-t border-gray-200 pt-5">
                    <div class="relative flex items-start">
                        <div class="flex items-center h-5">
                            <input id="save_mapping" name="save_mapping" type="checkbox" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded">
                        </div>
                        <div class="ml-3 text-sm">
                            <label for="save_mapping" class="font-medium text-gray-700">Save this mapping for future imports</label>
                        </div>
                    </div>
                    
                    <div id="save-mapping-options" class="mt-4 pl-7 hidden">
                        <div class="space-y-4">
                            <div>
                                <label for="mapping_name" class="block text-sm font-medium text-gray-700">Mapping Name</label>
                                <div class="mt-1">
                                    <input type="text" name="mapping_name" id="mapping_name" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
                                </div>
                            </div>
                            
                            <div class="relative flex items-start">
                                <div class="flex items-center h-5">
                                    <input id="set_default" name="set_default" type="checkbox" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded">
                                </div>
                                <div class="ml-3 text-sm">
                                    <label for="set_default" class="font-medium text-gray-700">Set as default mapping</label>
                                    <p class="text-gray-500">This mapping will be automatically selected for future imports</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="pt-5 border-t border-gray-200">
                    <div class="flex justify-end">
                        <a href="{% url 'import_file' %}" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Cancel</a>
                        <button type="submit" class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Import Data</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Field Type Templates (Hidden) -->
<template id="base-fields-template">
    {% for field in base_fields %}
    <option value="{{ field.name }}">{{ field.label }}</option>
    {% endfor %}
</template>

<template id="custom-fields-template">
    {% for field in custom_fields %}
    <option value="{{ field.name }}">{{ field.label }}</option>
    {% endfor %}
</template>

<template id="ignore-field-template">
    <option value="ignore">Ignore this column</option>
</template>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const mappingForm = document.getElementById('mapping-form');
        const mappingDataInput = document.getElementById('mapping-data');
        const saveMapping = document.getElementById('save_mapping');
        const saveMappingOptions = document.getElementById('save-mapping-options');
        const existingMappingSelect = document.getElementById('existing-mapping');
        
        // Show/hide save mapping options
        saveMapping.addEventListener('change', function() {
            if (this.checked) {
                saveMappingOptions.classList.remove('hidden');
            } else {
                saveMappingOptions.classList.add('hidden');
            }
        });
        
        // Handle field type change
        function addFieldTypeChangeListener(select) {
            select.addEventListener('change', function() {
                const fieldNameSelect = this.closest('tr').querySelector('.field-name-select');
                const requiredCheckbox = this.closest('tr').querySelector('[name="is_required"]');
                const defaultValueInput = this.closest('tr').querySelector('[name="default_value"]');
                
                // Clear existing options
                fieldNameSelect.innerHTML = '';
                
                // Add new options based on field type
                if (this.value === 'base') {
                    fieldNameSelect.innerHTML = document.getElementById('base-fields-template').innerHTML;
                    fieldNameSelect.disabled = false;
                    requiredCheckbox.disabled = false;
                    defaultValueInput.disabled = false;
                } else if (this.value === 'custom') {
                    fieldNameSelect.innerHTML = document.getElementById('custom-fields-template').innerHTML;
                    fieldNameSelect.disabled = false;
                    requiredCheckbox.disabled = false;
                    defaultValueInput.disabled = false;
                } else {  // ignore
                    fieldNameSelect.innerHTML = document.getElementById('ignore-field-template').innerHTML;
                    fieldNameSelect.disabled = true;
                    requiredCheckbox.disabled = true;
                    requiredCheckbox.checked = false;
                    defaultValueInput.disabled = true;
                    defaultValueInput.value = '';
                }
            });
        }
        
        // Add event listeners to existing rows
        document.querySelectorAll('.field-type-select').forEach(addFieldTypeChangeListener);
        
        // Handle existing mapping selection
        if (existingMappingSelect) {
            existingMappingSelect.addEventListener('change', function() {
                if (!this.value) return;
                
                // Apply the selected mapping
                {% if mapping_fields %}
                const mappingFields = {{ mapping_fields|safe }};
                const rows = document.querySelectorAll('.mapping-row');
                
                rows.forEach(row => {
                    const csvColumn = row.querySelector('[name="csv_column"]').value;
                    const fieldTypeSelect = row.querySelector('[name="field_type"]');
                    const fieldNameSelect = row.querySelector('[name="field_name"]');
                    const requiredCheckbox = row.querySelector('[name="is_required"]');
                    const defaultValueInput = row.querySelector('[name="default_value"]');
                    
                    // Find matching field in the mapping
                    const matchingField = mappingFields.find(field => field.csv_column === csvColumn);
                    
                    if (matchingField) {
                        // Set field type
                        fieldTypeSelect.value = matchingField.field_type;
                        
                        // Trigger change event to update field name options
                        const event = new Event('change');
                        fieldTypeSelect.dispatchEvent(event);
                        
                        // Set field name
                        fieldNameSelect.value = matchingField.field_name;
                        
                        // Set required
                        requiredCheckbox.checked = matchingField.is_required;
                        
                        // Set default value
                        defaultValueInput.value = matchingField.default_value || '';
                    }
                });
                {% endif %}
            });
            
            // Trigger change event if a mapping is selected
            if (existingMappingSelect.value) {
                const event = new Event('change');
                existingMappingSelect.dispatchEvent(event);
            }
        }
        
        // Handle form submission
        mappingForm.addEventListener('submit', function(e) {
            // Collect mapping data
            const mappingData = {};
            
            document.querySelectorAll('.mapping-row').forEach(row => {
                const csvColumn = row.querySelector('[name="csv_column"]').value;
                const fieldType = row.querySelector('[name="field_type"]').value;
                
                // Skip ignored columns
                if (fieldType === 'ignore') return;
                
                const fieldName = row.querySelector('[name="field_name"]').value;
                const required = row.querySelector('[name="is_required"]').checked;
                const defaultValue = row.querySelector('[name="default_value"]').value;
                
                mappingData[csvColumn] = {
                    field_type: fieldType,
                    field_name: fieldName,
                    required: required,
                    default_value: defaultValue
                };
            });
            
            // Set the mapping data input value
            mappingDataInput.value = JSON.stringify(mappingData);
            
            // Validate save mapping options
            if (saveMapping.checked && !document.getElementById('mapping_name').value) {
                e.preventDefault();
                alert('Please enter a name for the mapping');
                return;
            }
        });
    });
</script>
{% endblock %}
