{% extends 'base.html' %}
{% load customer_tags %}

{% block title %}Bulk Status Update - {{ COMPANY_NAME }}{% endblock %}

{% block header %}Bulk Status Update{% endblock %}
{% block header_icon %}<i class="fas fa-tasks"></i>{% endblock %}
{% block subheader %}Update multiple customer statuses at once{% endblock %}

{% block content %}
<div class="bg-white shadow overflow-hidden sm:rounded-lg mb-6">
    <div class="px-4 py-5 sm:p-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900">Update Customer Statuses</h3>
        <div class="mt-2 max-w-xl text-sm text-gray-500">
            <p>Use this form to update the status of multiple customers at once. You can filter customers by their current status, assignment status, or area.</p>
        </div>
        
        <form id="bulk-status-form" method="POST" action="{% url 'bulk_status_update' %}" class="mt-5">
            {% csrf_token %}
            
            <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                <!-- New Status Selection -->
                <div class="sm:col-span-3">
                    <label for="new_status" class="block text-sm font-medium text-gray-700">New Status</label>
                    <div class="mt-1 relative rounded-md shadow-sm">
                        <select id="new_status" name="new_status" required class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
                            <option value="">Select a status</option>
                            {% for status_value, status_label in statuses %}
                            <option value="{{ status_value }}">{{ status_label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <!-- Filter by Current Status -->
                <div class="sm:col-span-3">
                    <label for="filter_status" class="block text-sm font-medium text-gray-700">Filter by Current Status</label>
                    <div class="mt-1 relative rounded-md shadow-sm">
                        <select id="filter_status" name="filter_status" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
                            <option value="">All Statuses</option>
                            {% for status_value, status_label in statuses %}
                            <option value="{{ status_value }}">{{ status_label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <!-- Filter by Assignment Status -->
                <div class="sm:col-span-3">
                    <label for="filter_assigned" class="block text-sm font-medium text-gray-700">Filter by Assignment</label>
                    <div class="mt-1 relative rounded-md shadow-sm">
                        <select id="filter_assigned" name="filter_assigned" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
                            <option value="">All Customers</option>
                            <option value="assigned">Assigned Only</option>
                            <option value="unassigned">Unassigned Only</option>
                        </select>
                    </div>
                </div>
                
                <!-- Filter by Area -->
                <div class="sm:col-span-3">
                    <label for="filter_area" class="block text-sm font-medium text-gray-700">Filter by Area</label>
                    <div class="mt-1 relative rounded-md shadow-sm">
                        <select id="filter_area" name="filter_area" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
                            <option value="">All Areas</option>
                            {% for area in areas %}
                            <option value="{{ area }}">{{ area }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <!-- Add Note -->
                <div class="sm:col-span-6">
                    <label for="add_note" class="block text-sm font-medium text-gray-700">Add Note (Optional)</label>
                    <div class="mt-1">
                        <textarea id="add_note" name="add_note" rows="3" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md" placeholder="Add a note about this bulk update"></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Filter Button -->
            <div class="mt-5 flex justify-between items-center">
                <button type="button" id="filter-customers" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <i class="fas fa-filter mr-2"></i> Filter Customers
                </button>
                
                <div class="flex items-center">
                    <span id="selected-count" class="text-sm text-gray-500 mr-4">0 customers selected</span>
                    <button type="submit" id="update-status-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" disabled>
                        <i class="fas fa-tasks mr-2"></i> Update Status
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Customer Selection Table -->
<div class="bg-white shadow overflow-hidden sm:rounded-lg">
    <div class="px-4 py-5 sm:px-6 flex justify-between items-center">
        <div>
            <h3 class="text-lg leading-6 font-medium text-gray-900">Select Customers</h3>
            <p class="mt-1 max-w-2xl text-sm text-gray-500">Select specific customers to update or use the filters above</p>
        </div>
        <div>
            <button type="button" id="select-all" class="text-sm text-indigo-600 hover:text-indigo-900">Select All</button>
            <span class="mx-2 text-gray-300">|</span>
            <button type="button" id="deselect-all" class="text-sm text-indigo-600 hover:text-indigo-900">Deselect All</button>
        </div>
    </div>
    <div class="border-t border-gray-200">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <input type="checkbox" id="select-all-checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Name
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Phone
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Area
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Status
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Assigned To
                        </th>
                    </tr>
                </thead>
                <tbody id="customer-table-body" class="bg-white divide-y divide-gray-200">
                    {% for customer in customers %}
                    <tr class="customer-row" 
                        data-status="{{ customer.status }}" 
                        data-assigned="{{ customer.assigned_to.id|default:'unassigned' }}" 
                        data-area="{{ customer.area|default:'' }}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="checkbox" name="customer_ids" value="{{ customer.id }}" class="customer-checkbox h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">{{ customer.name }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">{{ customer.phone_number }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">{{ customer.area|default:"-" }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {{ customer.status|status_badge }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {% if customer.assigned_to %}
                            {{ customer.assigned_to.get_full_name|default:customer.assigned_to.username }}
                            {% else %}
                            <span class="text-yellow-600">Unassigned</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                            No customers found
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div id="preview-modal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
            <div>
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100">
                    <i class="fas fa-exclamation-triangle text-yellow-600"></i>
                </div>
                <div class="mt-3 text-center sm:mt-5">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                        Confirm Status Update
                    </h3>
                    <div class="mt-2">
                        <p class="text-sm text-gray-500">
                            You are about to update <span id="update-count" class="font-semibold">0</span> customers to status: 
                            <span id="new-status-display" class="font-semibold"></span>
                        </p>
                        <p class="mt-2 text-sm text-gray-500">
                            This action cannot be undone. Are you sure you want to continue?
                        </p>
                    </div>
                </div>
            </div>
            <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                <button type="button" id="confirm-update" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:col-start-2 sm:text-sm">
                    Confirm Update
                </button>
                <button type="button" id="cancel-update" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:col-start-1 sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const bulkStatusForm = document.getElementById('bulk-status-form');
        const filterCustomersBtn = document.getElementById('filter-customers');
        const selectAllBtn = document.getElementById('select-all');
        const deselectAllBtn = document.getElementById('deselect-all');
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const customerRows = document.querySelectorAll('.customer-row');
        const customerCheckboxes = document.querySelectorAll('.customer-checkbox');
        const selectedCountDisplay = document.getElementById('selected-count');
        const updateStatusBtn = document.getElementById('update-status-btn');
        const newStatusSelect = document.getElementById('new_status');
        const filterStatusSelect = document.getElementById('filter_status');
        const filterAssignedSelect = document.getElementById('filter_assigned');
        const filterAreaSelect = document.getElementById('filter_area');
        
        // Preview modal elements
        const previewModal = document.getElementById('preview-modal');
        const updateCountDisplay = document.getElementById('update-count');
        const newStatusDisplay = document.getElementById('new-status-display');
        const confirmUpdateBtn = document.getElementById('confirm-update');
        const cancelUpdateBtn = document.getElementById('cancel-update');
        
        // Function to update the selected count display
        function updateSelectedCount() {
            const selectedCount = document.querySelectorAll('.customer-checkbox:checked').length;
            selectedCountDisplay.textContent = `${selectedCount} customers selected`;
            updateStatusBtn.disabled = selectedCount === 0;
        }
        
        // Function to filter customers based on selected criteria
        function filterCustomers() {
            const statusFilter = filterStatusSelect.value;
            const assignedFilter = filterAssignedSelect.value;
            const areaFilter = filterAreaSelect.value;
            
            customerRows.forEach(row => {
                let visible = true;
                
                if (statusFilter && row.dataset.status !== statusFilter) {
                    visible = false;
                }
                
                if (assignedFilter) {
                    if (assignedFilter === 'assigned' && row.dataset.assigned === 'unassigned') {
                        visible = false;
                    } else if (assignedFilter === 'unassigned' && row.dataset.assigned !== 'unassigned') {
                        visible = false;
                    }
                }
                
                if (areaFilter && row.dataset.area !== areaFilter) {
                    visible = false;
                }
                
                row.style.display = visible ? '' : 'none';
            });
            
            // Uncheck the select all checkbox
            selectAllCheckbox.checked = false;
            updateSelectedCount();
        }
        
        // Event listener for the filter button
        if (filterCustomersBtn) {
            filterCustomersBtn.addEventListener('click', filterCustomers);
        }
        
        // Event listener for select all button
        if (selectAllBtn) {
            selectAllBtn.addEventListener('click', function() {
                const visibleCheckboxes = Array.from(customerCheckboxes).filter(
                    checkbox => checkbox.closest('tr').style.display !== 'none'
                );
                
                visibleCheckboxes.forEach(checkbox => {
                    checkbox.checked = true;
                });
                
                selectAllCheckbox.checked = visibleCheckboxes.length > 0;
                updateSelectedCount();
            });
        }
        
        // Event listener for deselect all button
        if (deselectAllBtn) {
            deselectAllBtn.addEventListener('click', function() {
                customerCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                selectAllCheckbox.checked = false;
                updateSelectedCount();
            });
        }
        
        // Event listener for select all checkbox
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                const visibleCheckboxes = Array.from(customerCheckboxes).filter(
                    checkbox => checkbox.closest('tr').style.display !== 'none'
                );
                
                visibleCheckboxes.forEach(checkbox => {
                    checkbox.checked = selectAllCheckbox.checked;
                });
                
                updateSelectedCount();
            });
        }
        
        // Event listeners for individual checkboxes
        customerCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectedCount);
        });
        
        // Initialize the selected count
        updateSelectedCount();
        
        // Event listener for the update status button
        if (updateStatusBtn) {
            updateStatusBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                const selectedCount = document.querySelectorAll('.customer-checkbox:checked').length;
                const newStatus = newStatusSelect.value;
                
                if (!newStatus) {
                    alert('Please select a new status');
                    return;
                }
                
                if (selectedCount === 0) {
                    alert('Please select at least one customer');
                    return;
                }
                
                // Update the preview modal
                updateCountDisplay.textContent = selectedCount;
                const statusOption = newStatusSelect.options[newStatusSelect.selectedIndex];
                newStatusDisplay.textContent = statusOption.text;
                
                // Show the preview modal
                previewModal.classList.remove('hidden');
            });
        }
        
        // Event listener for the confirm update button
        if (confirmUpdateBtn) {
            confirmUpdateBtn.addEventListener('click', function() {
                bulkStatusForm.submit();
            });
        }
        
        // Event listener for the cancel update button
        if (cancelUpdateBtn) {
            cancelUpdateBtn.addEventListener('click', function() {
                previewModal.classList.add('hidden');
            });
        }
    });
</script>
{% endblock %}