{% extends 'base.html' %}
{% load customer_tags %}

{% block title %}Customers - {{ COMPANY_NAME }}{% endblock %}

{% block header %}Prospective Students{% endblock %}
{% block header_icon %}<i class="fas fa-users"></i>{% endblock %}
{% block subheader %}Track and manage potential students throughout their enrollment journey{% endblock %}

{% block content %}
<div class="card-enhanced bg-white shadow-md overflow-hidden sm:rounded-lg animate-fadeIn">
    <div class="px-4 py-5 sm:p-6">
        <!-- Search and Filter -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 space-y-4 md:space-y-0">
            <div class="flex flex-col sm:flex-row sm:items-center space-y-4 sm:space-y-0 sm:space-x-4">
                <div class="w-full sm:w-64">
                    <form method="GET" class="flex rounded-md shadow-sm" id="search-form">
                        <div class="relative flex-grow">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" name="search" value="{{ search_query|default:'' }}" placeholder="Search by name, phone, area..." class="form-control-enhanced pl-10 pr-10 py-2 w-full">
                            {% if search_query %}
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                <button type="button" id="clear-search" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            {% endif %}
                        </div>
                        <button type="submit" class="ml-3 btn-enhanced btn-primary px-4 py-2 rounded-md">
                            <span>Search</span>
                        </button>
                    </form>
                </div>
                <div class="w-full sm:w-48">
                    <div class="relative">
                        <select id="status-filter" class="form-control-enhanced appearance-none pl-3 pr-10 py-2 w-full">
                            <option value="all" {% if not current_status %}selected{% endif %}>All Enrollment Stages</option>
                            {% for status, label in statuses %}
                            <option value="{{ status }}" {% if current_status == status %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                            <i class="fas fa-chevron-down text-gray-400"></i>
                        </div>
                    </div>
                </div>
            </div>
            {% if user.is_manager %}
            <div>
                <a href="{% url 'unassigned_customers' %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <i class="fas fa-user-plus mr-2"></i> Assign Customers
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Customer List -->
        <div class="mt-6 flow-root">
            <div class="overflow-x-auto">
                <table class="table-enhanced min-w-full">
                    <thead>
                        <tr>
                            <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-0">
                                <div class="flex items-center">
                                    <i class="fas fa-user text-indigo-400 mr-2"></i>
                                    <span>Name</span>
                                </div>
                            </th>
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">
                                <div class="flex items-center">
                                    <i class="fas fa-phone text-indigo-400 mr-2"></i>
                                    <span>Phone</span>
                                </div>
                            </th>
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">
                                <div class="flex items-center">
                                    <i class="fas fa-map-marker-alt text-indigo-400 mr-2"></i>
                                    <span>Area</span>
                                </div>
                            </th>
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">
                                <div class="flex items-center">
                                    <i class="fas fa-calendar-alt text-indigo-400 mr-2"></i>
                                    <span>Date</span>
                                </div>
                            </th>
                            {% if user.is_manager %}
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">
                                <div class="flex items-center">
                                    <i class="fas fa-user-check text-indigo-400 mr-2"></i>
                                    <span>Assigned To</span>
                                </div>
                            </th>
                            {% endif %}
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">
                                <div class="flex items-center">
                                    <i class="fas fa-tag text-indigo-400 mr-2"></i>
                                    <span>Status</span>
                                </div>
                            </th>
                            <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-0">
                                <span class="sr-only">Actions</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for customer in customers %}
                        <tr class="hover:bg-gray-50 transition-colors duration-150">
                            <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-0">{{ customer.name }}</td>
                            <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                                <a href="tel:{{ customer.phone_number }}" class="text-indigo-600 hover:text-indigo-900 transition-colors duration-150">
                                    {{ customer.phone_number }}
                                </a>
                            </td>
                            <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">{{ customer.area|default:"-" }}</td>
                            <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">{{ customer.date|date:"d/m/Y"|default:"-" }}</td>
                            {% if user.is_manager %}
                            <td class="whitespace-nowrap px-3 py-4 text-sm">
                                {% if customer.assigned_to %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    <i class="fas fa-user-check mr-1"></i>
                                    {{ customer.assigned_to.get_full_name|default:customer.assigned_to.username }}
                                </span>
                                {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                    <i class="fas fa-user-plus mr-1"></i>
                                    Unassigned
                                </span>
                                {% endif %}
                            </td>
                            {% endif %}
                            <td class="whitespace-nowrap px-3 py-4 text-sm">
                                {{ customer.status|status_badge }}
                            </td>
                            <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-0">
                                <a href="{% url 'customer_detail' customer.id %}" class="btn-enhanced inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 transition-colors duration-150">
                                    <i class="fas fa-eye mr-1"></i>
                                    View
                                </a>
                            </td>
                        </tr>
                            {% empty %}
                            <tr>
                                <td colspan="{% if user.is_manager %}7{% else %}6{% endif %}" class="py-4 text-sm text-gray-500 text-center">No customers found</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination -->
            {% include 'includes/pagination.html' %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Status filter functionality
        const statusFilter = document.getElementById('status-filter');
        statusFilter.addEventListener('change', function() {
            const currentUrl = new URL(window.location.href);
            const searchParams = currentUrl.searchParams;

            if (statusFilter.value === 'all') {
                searchParams.delete('status');
            } else {
                searchParams.set('status', statusFilter.value);
            }

            window.location.href = currentUrl.toString();
        });

        // Clear search functionality
        const clearSearchBtn = document.getElementById('clear-search');
        if (clearSearchBtn) {
            clearSearchBtn.addEventListener('click', function() {
                const currentUrl = new URL(window.location.href);
                const searchParams = currentUrl.searchParams;
                searchParams.delete('search');
                window.location.href = currentUrl.toString();
            });
        }

        // Enhance status badges
        enhanceStatusBadges();

        // Add row hover effect
        const tableRows = document.querySelectorAll('tbody tr');
        tableRows.forEach(row => {
            row.addEventListener('mouseenter', function() {
                this.classList.add('bg-gray-50');
                const viewBtn = this.querySelector('a.btn-enhanced');
                if (viewBtn) {
                    viewBtn.classList.add('transform', 'scale-105');
                }
            });

            row.addEventListener('mouseleave', function() {
                this.classList.remove('bg-gray-50');
                const viewBtn = this.querySelector('a.btn-enhanced');
                if (viewBtn) {
                    viewBtn.classList.remove('transform', 'scale-105');
                }
            });
        });
    });
</script>
{% endblock %}
